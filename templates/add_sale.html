{% extends "base.html" %}

{% block title %}Registrar Venda - ERP Mercado{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1><i class="fas fa-cash-register"></i> Registrar Venda</h1>
    <a href="{{ url_for('sales') }}" class="btn btn-secondary">
        <i class="fas fa-arrow-left"></i> Voltar
    </a>
</div>

<div class="card">
    <div class="card-body">
        <form method="POST">
            <div class="alert alert-info">
                <i class="fas fa-qrcode"></i> Use o leitor de QR Code para encontrar produtos rapidamente ou selecione manualmente na lista.
            </div>
            
            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label for="product_id" class="form-label">Produto *</label>
                        <div class="input-group">
                            <select class="form-select" id="product_id" name="product_id" required>
                                <option value="">Selecione um produto...</option>
                                {% for product in products %}
                                <option value="{{ product.id }}" data-price="{{ product.price }}" data-stock="{{ product.stock_quantity }}" data-sku="{{ product.sku }}">
                                    {{ product.name }} - Estoque: {{ product.stock_quantity }}
                                </option>
                                {% endfor %}
                            </select>
                            <button type="button" class="btn btn-outline-primary" id="scanQRBtn">
                                <i class="fas fa-camera"></i> Escanear QR
                            </button>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="mb-3">
                        <label for="customer_name" class="form-label">Cliente</label>
                        <input type="text" class="form-control" id="customer_name" name="customer_name" placeholder="Nome do cliente">
                    </div>
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-4">
                    <div class="mb-3">
                        <label for="quantity" class="form-label">Quantidade *</label>
                        <input type="number" class="form-control" id="quantity" name="quantity" min="1" required>
                        <div class="form-text">Estoque disponível: <span id="available_stock">-</span></div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="mb-3">
                        <label for="unit_price" class="form-label">Preço Unitário (R$) *</label>
                        <input type="number" class="form-control" id="unit_price" name="unit_price" step="0.01" min="0" required>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="mb-3">
                        <label for="total_price" class="form-label">Total (R$)</label>
                        <input type="number" class="form-control" id="total_price" step="0.01" readonly>
                    </div>
                </div>
            </div>
            
            <div class="mb-3">
                <label for="notes" class="form-label">Observações</label>
                <textarea class="form-control" id="notes" name="notes" rows="3" placeholder="Observações sobre a venda..."></textarea>
            </div>
            
            <div class="d-flex gap-2">
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-save"></i> Registrar Venda
                </button>
                <a href="{{ url_for('sales') }}" class="btn btn-secondary">
                    <i class="fas fa-times"></i> Cancelar
                </a>
            </div>
        </form>
    </div>
</div>

<!-- Modal para Scanner de QR Code -->
<div class="modal fade" id="qrScannerModal" tabindex="-1" aria-labelledby="qrScannerModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="qrScannerModalLabel">Escanear QR Code do Produto</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="text-center">
                    <div id="cameraPermissionInfo" class="alert alert-info mb-3">
                        <i class="fas fa-info-circle"></i> 
                        <strong>Importante:</strong> Este recurso precisa de acesso à sua câmera. 
                        Quando solicitado, clique em "Permitir" para usar o scanner de QR Code.
                    </div>
                    
                    <video id="qrVideo" width="100%" height="300" style="border: 2px solid #ddd; border-radius: 8px; display: none;"></video>
                    <canvas id="qrCanvas" style="display: none;"></canvas>
                    
                    <div id="cameraLoading" class="mt-3">
                        <div class="d-flex flex-column align-items-center">
                            <div class="spinner-border text-primary mb-2" role="status">
                                <span class="visually-hidden">Carregando...</span>
                            </div>
                            <p class="text-muted">Iniciando câmera... Por favor, permita o acesso quando solicitado.</p>
                        </div>
                    </div>
                    
                    <div id="cameraControls" class="mt-3" style="display: none;">
                        <p class="text-muted">Posicione o QR Code do produto na frente da câmera</p>
                        <button type="button" class="btn btn-secondary" id="stopScanBtn">
                            <i class="fas fa-stop"></i> Parar Scanner
                        </button>
                    </div>
                    
                    <div id="scanResult" class="mt-3" style="display: none;">
                        <div class="alert alert-success">
                            <strong>Produto encontrado:</strong> <span id="foundProductName"></span><br>
                            <small>SKU: <code id="foundProductSku"></code></small>
                        </div>
                    </div>
                    <div id="scanError" class="mt-3" style="display: none;">
                        <div class="alert alert-danger">
                            <strong>Produto não encontrado!</strong> Verifique se o QR Code está correto.
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const productSelect = document.getElementById('product_id');
    const quantityInput = document.getElementById('quantity');
    const unitPriceInput = document.getElementById('unit_price');
    const totalPriceInput = document.getElementById('total_price');
    const availableStockSpan = document.getElementById('available_stock');
    const scanQRBtn = document.getElementById('scanQRBtn');
    const stopScanBtn = document.getElementById('stopScanBtn');
    const video = document.getElementById('qrVideo');
    const canvas = document.getElementById('qrCanvas');
    const ctx = canvas.getContext('2d');
    let scanning = false;
    let stream = null;
    
    function updateProductInfo() {
        const selectedOption = productSelect.options[productSelect.selectedIndex];
        if (selectedOption.value) {
            const price = selectedOption.dataset.price;
            const stock = selectedOption.dataset.stock;
            
            unitPriceInput.value = price;
            availableStockSpan.textContent = stock;
            quantityInput.max = stock;
            updateTotal();
        } else {
            unitPriceInput.value = '';
            availableStockSpan.textContent = '-';
            quantityInput.max = '';
            totalPriceInput.value = '';
        }
    }
    
    function updateTotal() {
        const quantity = parseFloat(quantityInput.value) || 0;
        const unitPrice = parseFloat(unitPriceInput.value) || 0;
        const total = quantity * unitPrice;
        totalPriceInput.value = total.toFixed(2);
    }
    
    function selectProductBySKU(sku) {
        const options = productSelect.options;
        for (let i = 0; i < options.length; i++) {
            if (options[i].dataset.sku === sku) {
                productSelect.selectedIndex = i;
                updateProductInfo();
                return true;
            }
        }
        return false;
    }
    
    function showCameraLoading() {
        document.getElementById('cameraLoading').style.display = 'block';
        document.getElementById('cameraControls').style.display = 'none';
        document.getElementById('qrVideo').style.display = 'none';
        document.getElementById('scanResult').style.display = 'none';
        document.getElementById('scanError').style.display = 'none';
    }
    
    function showCameraReady() {
        document.getElementById('cameraLoading').style.display = 'none';
        document.getElementById('cameraControls').style.display = 'block';
        document.getElementById('qrVideo').style.display = 'block';
        document.getElementById('scanResult').style.display = 'none';
        document.getElementById('scanError').style.display = 'none';
    }

    async function startScanning() {
        try {
            // Mostrar loading
            showCameraLoading();
            
            // Verificar se getUserMedia está disponível
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                alert('Seu navegador não suporta acesso à câmera. Use um navegador mais recente.');
                return;
            }

            // Solicitar permissão para a câmera
            stream = await navigator.mediaDevices.getUserMedia({ 
                video: { 
                    facingMode: 'environment',
                    width: { ideal: 640 },
                    height: { ideal: 480 }
                } 
            });
            
            video.srcObject = stream;
            video.setAttribute('playsinline', true);
            
            // Aguardar o vídeo carregar antes de iniciar o scan
            video.onloadedmetadata = () => {
                showCameraReady();
                video.play();
                scanning = true;
                requestAnimationFrame(tick);
            };
            
        } catch (err) {
            console.error('Error accessing camera:', err);
            let errorMessage = 'Erro ao acessar a câmera.\n\n';
            
            if (err.name === 'NotAllowedError') {
                errorMessage += '❌ Permissão negada.\n\nPara usar o scanner:\n1. Clique no ícone da câmera na barra de endereços\n2. Selecione "Permitir" para este site\n3. Tente novamente';
            } else if (err.name === 'NotFoundError') {
                errorMessage += '📹 Nenhuma câmera encontrada no dispositivo.';
            } else if (err.name === 'NotSupportedError') {
                errorMessage += '🚫 Seu navegador não suporta acesso à câmera.';
            } else if (err.name === 'SecurityError') {
                errorMessage += '🔒 Erro de segurança. Certifique-se de estar usando HTTPS.';
            } else {
                errorMessage += '⚠️ Verifique se a câmera não está sendo usada por outro aplicativo.';
            }
            
            alert(errorMessage);
            
            // Fechar modal em caso de erro
            bootstrap.Modal.getInstance(document.getElementById('qrScannerModal')).hide();
        }
    }
    
    function stopScanning() {
        scanning = false;
        if (stream) {
            stream.getTracks().forEach(track => track.stop());
            stream = null;
        }
        video.srcObject = null;
    }
    
    function tick() {
        if (video.readyState === video.HAVE_ENOUGH_DATA && scanning) {
            canvas.height = video.videoHeight;
            canvas.width = video.videoWidth;
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const code = jsQR(imageData.data, imageData.width, imageData.height, {
                inversionAttempts: "dontInvert",
            });
            
            if (code) {
                console.log("QR Code detected:", code.data);
                handleQRCodeDetected(code.data);
            }
        }
        
        if (scanning) {
            requestAnimationFrame(tick);
        }
    }
    
    async function handleQRCodeDetected(sku) {
        scanning = false;
        
        try {
            const response = await fetch(`/api/search_product_by_sku/${sku}`);
            const result = await response.json();
            
            if (result.success) {
                document.getElementById('foundProductName').textContent = result.product.name;
                document.getElementById('foundProductSku').textContent = result.product.sku;
                document.getElementById('scanResult').style.display = 'block';
                document.getElementById('scanError').style.display = 'none';
                
                // Selecionar produto
                if (selectProductBySKU(sku)) {
                    setTimeout(() => {
                        bootstrap.Modal.getInstance(document.getElementById('qrScannerModal')).hide();
                        stopScanning();
                    }, 2000);
                }
            } else {
                document.getElementById('scanError').style.display = 'block';
                document.getElementById('scanResult').style.display = 'none';
                scanning = true;
                requestAnimationFrame(tick);
            }
        } catch (error) {
            console.error('Error searching product:', error);
            document.getElementById('scanError').style.display = 'block';
            document.getElementById('scanResult').style.display = 'none';
            scanning = true;
            requestAnimationFrame(tick);
        }
    }
    
    // Event listeners
    productSelect.addEventListener('change', updateProductInfo);
    quantityInput.addEventListener('input', updateTotal);
    unitPriceInput.addEventListener('input', updateTotal);
    
    scanQRBtn.addEventListener('click', function() {
        // Resetar o estado visual do modal
        showCameraLoading();
        const modal = new bootstrap.Modal(document.getElementById('qrScannerModal'));
        modal.show();
        
        // Aguardar um pouco para o modal aparecer antes de iniciar a câmera
        setTimeout(() => {
            startScanning();
        }, 300);
    });
    
    stopScanBtn.addEventListener('click', function() {
        stopScanning();
        bootstrap.Modal.getInstance(document.getElementById('qrScannerModal')).hide();
    });
    
    // Stop scanning when modal is closed
    document.getElementById('qrScannerModal').addEventListener('hidden.bs.modal', function() {
        stopScanning();
    });
});
</script>
{% endblock %}
